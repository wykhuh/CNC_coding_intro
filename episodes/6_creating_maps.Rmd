---
title: "Creating maps"
teaching: 120
exercises: 4
---

```{r}
library(sf)
library(dplyr)
# library(leaflet)
library(here)
library(readr)

```
:::::::::::::::::::::::::::::::::::::: questions 

- How do we create maps?

::::::::::::::::::::::::::::::::::::::::::::::::

## Geographic data

There are various file formats for geographic data. Shape files for GIS applications, KML for Google maps, geojson for web applications.

You can get boundaries for countries, states, cities, etc from various sources. I googled "Los Angeles county boundary shape" which had a link to "County Boundary | City of Los Angeles Hub - LA GeoHub" https://geohub.lacity.org/datasets/10f1e37c065347e693cf4e8ee753c09b  I downloaded the shapefile for LA county.

You can also create your boundaries using GIS applications or GIS web applications.

##  Mapping iNaturalist data

iNaturalist data includes latitude and longitude, which means we can put the observations in a map. There are several packages to create maps. We will use ggplot and mapview packages.

First, read data from the cleaned iNaturalist observation file.


```{r}
path = here('data', 'cleaned', 'observations.csv')
inat <- read_csv(path)

```

See all the column names. "latitude" and "longitude"  are the column names we need.

```{r}
names(inat)
```


We use the sf package to add geographic data to our dataframe. `st_as_sf()` from `sf` package will take the longitude and latitude and add a geometry column that we can use for  mapping. 

- We pass in longitude and latitude columns to coors argument. Must wrap longitude and latitude in quotes. 
- crs is 	coordinate reference system. 
- `remove=FALSE` will keep the cooridate columns in the dataframe

```{r}
temp <- inat %>% 
  st_as_sf(coords = c("longitude", "latitude"),   crs = 4326, remove=FALSE)
```

use select to pick which columns to use.

```{r}
inat_map <- inat %>% 
  st_as_sf(coords = c("longitude", "latitude"),   crs = 4326, remove=FALSE) %>% 
  select(id, user_login, common_name, scientific_name, observed_on,  url, longitude, latitude, geometry) 


head(inat_map)
```

## static map

Use ggplot to plot the observations.

```{r}

ggplot() +
  geom_sf(data = inat_map)  

```
There are some observations that are outside of Los Angeles. Use filter to select observations in LA. 

```{r}
inat_map <- inat_map %>% 
  filter(latitude < 40)  


ggplot() +
  geom_sf(data = inat_map)  
```
## interactive map

use mapview package to create interactive maps. 

```{r}
mapview(inat_map)
```

Use `dim()` to show the number of rows and columns. There are over 90K rows, so the map is very slow. I suggest not using mapview if there are lots of rows.

```{r}
dim(inat_map)
```

To speed up the map, let's filter the list of observations. Get all observations for Western Fence Lizard.

```{r}
inat_lizard <- inat_map %>% 
  filter(common_name == 'Western Fence Lizard')

dim(inat_lizard)
```

Create map. You can zoom in and out. Click on observation to see the info.

```{r}
mapview(inat_lizard)
```

## working with other geographic files

Let's add LA county boundaries to the map. use `read_sf()` from `sf` package to read the shape file.

```{r}
path = here('data', 'raw', 'County_Boundary', 'County_Boundary.shp')
la_county <- read_sf(path)
                     
                    
la_county
```
add LA County to maps.

```{r}
ggplot() +
  geom_sf(data = la_county)  +
  geom_sf(data = inat_lizard) 
```

```{r}

mapview(la_county) +
  mapview(inat_lizard) 
```


## Exploring iNaturlist data 

Lets look for all iNaturalist observations made in Exposition Park. 




```{r}
path = here('data', 'raw', 'boundaries_expo_park_area.geojson')
expo_park <- st_read(path) %>% st_transform(4326)
```
```{r}
path = here('data', 'raw', 'boundaries_expo_park_area.geojson')
expo_park <- read_sf(path)   %>% st_transform(4326)
```

plot map of Expo Park.

```{r}
mapview(expo_park) 
```

We want to get observation inside Expo Park.

You should check if the crs for the inaturalist data and the Expo Park are the same

```{r}
crs(expo_park) == crs(inat_map)

```

Use `st_intersection()` to get  all observations that inside of Exposition Park.

```{r}
inat_expo <- inat_map %>% st_intersection(expo_park)
```
Use dim to get row and column count.  93K in LA county.  1191 observation in Expo Park.

```{r}
dim(inat_map)

dim(inat_expo)
```

Create map of all observations in Expo Park.

```{r}
mapview(expo_park) +
  mapview(inat_expo) 

```

Use alpha.regions to set opacity.
use col.regions to set color.

```{r}
mapview(expo_park,   alpha.regions=0.3, col.regions="#333333") +
  mapview(inat_expo) 
```

